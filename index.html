<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Tennis Club Les Acacias</title>
<style>
:root{
  --bg:#f5f7fa;
  --text:#222;
  --primary:#1976d2;
  --padel:#1976d2;
  --tennis:#388e3c;
  --foot:#757575;
  --accent:#fff;
  --shadow:0 2px 4px rgba(0,0,0,0.1);
  --cell:40px; /* hauteur 30min */
}
.dark{
  --bg:#1e1e1e;
  --text:#eee;
  --primary:#90caf9;
  --accent:#2b2b2b;
  --shadow:0 2px 4px rgba(0,0,0,0.5);
  background:var(--bg);
  color:var(--text);
}
body{margin:0;font-family:sans-serif;background:var(--bg);color:var(--text);} 
.hidden{display:none;}
header.banner{background:var(--primary);color:var(--accent);text-align:center;padding:1rem;}
nav.bottom{position:fixed;bottom:0;left:0;right:0;display:flex;background:var(--accent);box-shadow:var(--shadow);} 
nav.bottom button{flex:1;padding:0.5rem;border:none;background:none;cursor:pointer;color:var(--text);} 
button{cursor:pointer;border:none;border-radius:8px;padding:0.5rem 1rem;background:var(--primary);color:var(--accent);box-shadow:var(--shadow);} 
button:disabled{opacity:0.5;cursor:not-allowed;}
.big-btn{width:100%;margin:0.5rem 0;font-size:1.25rem;} 
.small-btn{font-size:0.9rem;margin:0.25rem 0;} 
.court{margin-bottom:1.5rem;} 
.slots{display:flex;flex-wrap:wrap;gap:0.5rem;} 
.slot{flex:1 1 calc(50% - 0.5rem);background:var(--accent);padding:0.5rem;border-radius:6px;box-shadow:var(--shadow);} 
.badge{padding:2px 4px;border-radius:4px;font-size:0.75rem;color:var(--accent);} 
.badge.price{background:#4caf50;} 
.badge.duration{background:#555;} 
#toast{position:fixed;bottom:1rem;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:0.5rem 1rem;border-radius:4px;opacity:0;transition:opacity .3s;z-index:1000;} 
#toast.show{opacity:1;} 
/* admin planning */
#adminGrid{overflow:auto;border:1px solid #ccc;position:relative;} 
#adminGrid .grid{display:grid;position:relative;} 
.time-col{background:#eee;z-index:2;} 
.court-col{border-left:1px solid #ccc;position:relative;} 
.time-slot{height:var(--cell);border-bottom:1px solid #ddd;font-size:0.7rem;padding-left:2px;} 
.booking{position:absolute;border-radius:6px;color:#fff;padding:2px 4px;font-size:0.75rem;box-shadow:var(--shadow);cursor:pointer;overflow:hidden;} 
.booking.padel{background:var(--padel);} 
.booking.tennis{background:var(--tennis);} 
.booking.football{background:var(--foot);} 
#adminToolbar{display:flex;flex-wrap:wrap;gap:0.5rem;margin-bottom:0.5rem;align-items:center;} 
#adminToolbar input[type="date"]{font-size:1rem;} 
#adminStats{margin-top:0.5rem;font-size:0.9rem;} 
</style>
</head>
<body>
<header class="banner"><h1 id="clubName">Tennis Club Les Acacias</h1></header>
<main>
<section id="home" class="view">
  <button id="toReserve" class="big-btn">Réserver un terrain</button>
  <button id="toEvents" class="big-btn">Événements à venir (<span id="eventCount">0</span>)</button>
  <button id="toContact" class="big-btn">Contacter le club</button>
  <button id="toMy" class="big-btn">Mes réservations</button>
  <button id="toAccount" class="big-btn">Mon compte</button>
  <button id="toAdmin" class="big-btn">Admin</button>
</section>

<section id="booking" class="view hidden">
  <div class="breadcrumb"><button class="small-btn backHome">Accueil</button> &gt; <span id="breadcrumbSport"></span></div>
  <div class="date-nav"><button id="prevDay">&lt;</button><input type="date" id="dateInput"><button id="nextDay">&gt;</button><button id="todayBtn">Aujourd'hui</button></div>
  <div id="courtsContainer"></div>
</section>

<section id="myBookings" class="view hidden">
  <div class="breadcrumb"><button class="small-btn backHome">Accueil</button> &gt; Mes réservations</div>
  <ul id="bookingList"></ul>
</section>

<section id="events" class="view hidden">
  <div class="breadcrumb"><button class="small-btn backHome">Accueil</button> &gt; Événements</div>
  <table id="eventsTable"><thead><tr><th>Date</th><th>Nom</th><th>Type</th><th>Frais</th><th></th></tr></thead><tbody></tbody></table>
</section>

<section id="account" class="view hidden">
  <div class="breadcrumb"><button class="small-btn backHome">Accueil</button> &gt; Mon compte</div>
  <form id="profileForm">
    <label>Nom<br><input id="profileName" required></label><br>
    <label>Email<br><input type="email" id="profileEmail" required></label><br>
    <label>Téléphone<br><input id="profilePhone" required></label><br>
    <label><input type="checkbox" id="darkToggle"> Mode sombre</label><br>
    <button type="submit">Enregistrer</button>
  </form>
</section>

<section id="admin" class="view hidden">
  <div class="breadcrumb"><button class="small-btn backHome">Accueil</button> &gt; Admin</div>
  <div id="adminToolbar">
    <button id="adminPrev">&lt;</button>
    <input type="date" id="adminDate">
    <button id="adminNext">&gt;</button>
    <select id="adminSportFilter"><option value="all">Tous</option><option value="Padel">Padel</option><option value="Tennis">Tennis</option><option value="Football">Football</option></select>
    <input id="adminSearch" placeholder="Recherche...">
    <button id="exportCsv">Export CSV</button>
  </div>
  <div id="adminGrid"></div>
  <div id="adminStats"></div>
</section>
</main>

<dialog id="sportDialog"><h2>Choisissez un sport</h2><div><button class="sportSelect" data-sport="Padel">Padel</button><button class="sportSelect" data-sport="Tennis">Tennis</button><button class="sportSelect" data-sport="Football">Football</button></div><button class="small-btn" onclick="sportDialog.close()">Fermer</button></dialog>
<dialog id="confirmDialog"><form id="confirmForm"><div id="confirmText"></div><label id="playerField" class="hidden">Joueurs<br><input id="playerCount" type="number" min="1" value="2"></label><button type="submit">Confirmer</button></form></dialog>
<dialog id="adminDialog"><form id="adminForm"><h3 id="adminFormTitle"></h3><label>Début<br><select id="adminStart"></select></label><label>Durée<br><select id="adminDuration"><option value="90">1h30</option><option value="120">2h</option></select></label><label>Nom<br><input id="adminName" required></label><label>Téléphone<br><input id="adminPhone"></label><label>Email<br><input type="email" id="adminEmail"></label><label id="adminPlayersLabel" class="hidden">Joueurs<br><input type="number" id="adminPlayers" min="1" value="2"></label><label>Status<br><select id="adminStatus"><option>confirmée</option><option>en cours</option><option>terminée</option><option>annulée</option><option>no-show</option></select></label><label>Score<br><input id="adminScore"></label><div style="margin-top:0.5rem;"><button id="adminSave" type="submit">Enregistrer</button><button type="button" id="adminDelete" class="small-btn" style="background:#e53935;color:#fff;margin-left:0.5rem;">Supprimer</button></div></form></dialog>

<dialog id="contactDialog"><div style="padding:1rem;"><h3>Contact</h3><p>Téléphone : <a href="tel:+33600000000">+33 6 00 00 00 00</a></p><p>Email : <a href="mailto:contact@les-acacias.fr">contact@les-acacias.fr</a></p><p>Adresse : Chemin des Acacias, 06800</p><button onclick="contactDialog.close()">Fermer</button></div></dialog>

<div id="toast" role="status" aria-live="polite"></div>
<script>
/* ==== Données de départ ==== */
const CLUB = { name: "Tennis Club Les Acacias", phone:"+33 6 00 00 00 00", email:"contact@les-acacias.fr", address:"Chemin des Acacias, 06800", website:"https://les-acacias-tennis-padel-foot.com" };
const OPENING = { start: "08:00", end: "22:30", stepMinutes: 30 };
const SPORTS = {
  "Padel":   { courts: [{id:"Padel 1"},{id:"Padel 2"},{id:"Padel 3"},{id:"Padel 4"},{id:"Padel 5"},{id:"Padel 6"}], durations:[90,120],
               pricingFn: ({startTimeISO, minutes}) => dynamicPadelPrice(startTimeISO, minutes) },
  "Tennis":  { courts: [{id:"Tennis 1"},{id:"Tennis 2"},{id:"Tennis 3"},{id:"Tennis 4"}], durations:[90,120],
               pricingFn: ({minutes, players=2}) => (8 * (minutes/60) * players) },
  "Football":{ courts: [{id:"Foot 1"},{id:"Foot 2"},{id:"Foot 3"}], durations:[90,120],
               pricingFn: ({minutes}) => (50 * (minutes/60)) }
};
const LIMITS = { maxActiveBookingsPerUser: 4, cancelCutoffHours: 24 };
const EVENTS = [
  { date:"2025-09-27", title:"P100 Hommes", type:"Tournoi", fee:20, sport:"Padel" },
  { date:"2025-10-04", title:"P100 Femmes", type:"Tournoi", fee:20, sport:"Padel" },
  { date:"2025-10-25", title:"P100 Mixte",  type:"Tournoi", fee:20, sport:"Padel" },
  { date:"2025-10-26", title:"P250 Femmes", type:"Tournoi", fee:20, sport:"Padel" },
  { date:"2025-11-01", title:"P500 Hommes", type:"Tournoi", fee:20, sport:"Padel" },
  { date:"2025-11-02", title:"P25 Hommes",  type:"Tournoi", fee:20, sport:"Padel" },
  { date:"2025-11-15", title:"P25 Femmes",  type:"Tournoi", fee:20, sport:"Padel" }
];
/* ==== Utilitaires ==== */
function storageGet(key,def){return JSON.parse(localStorage.getItem(key) || JSON.stringify(def));}
function storageSet(key,val){localStorage.setItem(key,JSON.stringify(val));}
if(!localStorage.getItem('events')) storageSet('events', EVENTS);
if(!localStorage.getItem('bookings')){
  const demo=[
    {id:'b1',sport:'Padel',courtId:'Padel 1',date:'2025-05-10',startISO:'2025-05-10T16:30:00',endISO:'2025-05-10T18:00:00',minutes:90,players:null,price:9.5,createdBy:'admin',customer:{name:'Alice'},status:'confirmée'},
    {id:'b2',sport:'Tennis',courtId:'Tennis 2',date:'2025-05-10',startISO:'2025-05-10T10:00:00',endISO:'2025-05-10T11:30:00',minutes:90,players:2,price:24,createdBy:'admin',customer:{name:'Bob'},status:'confirmée'},
    {id:'b3',sport:'Football',courtId:'Foot 1',date:'2025-05-10',startISO:'2025-05-10T19:00:00',endISO:'2025-05-10T21:00:00',minutes:120,players:null,price:100,createdBy:'admin',customer:{name:'Club'},status:'confirmée'}
  ];
  storageSet('bookings',demo);
}
function loadProfile(){return storageGet('profile',{});} 
function saveProfile(p){storageSet('profile',p);} 
function loadPrefs(){return storageGet('prefs',{});} 
function savePrefs(p){storageSet('prefs',p);} 
function loadBookings(){return storageGet('bookings',[]);} 
function saveBookings(arr){storageSet('bookings',arr);} 
function loadBookingsByDate(date){return loadBookings().filter(b=>b.date===date);} 
function saveBooking(b){const arr=loadBookings();arr.push(b);saveBookings(arr);} 
function updateBooking(b){const arr=loadBookings();const i=arr.findIndex(x=>x.id===b.id);if(i>-1){arr[i]=b;saveBookings(arr);} }
function deleteBooking(id){saveBookings(loadBookings().filter(b=>b.id!==id));}
function generateTimeScale(open){const res=[];let cur=toMinutes(open.start);const end=toMinutes(open.end);while(cur<end){res.push(fromMinutes(cur));cur+=open.stepMinutes;}return res;}
function toMinutes(hm){const [h,m]=hm.split(':').map(Number);return h*60+m;}
function fromMinutes(m){const h=Math.floor(m/60).toString().padStart(2,'0');const mi=(m%60).toString().padStart(2,'0');return `${h}:${mi}`;}
function snapToStep(date,step){const ms=step*60000;return new Date(Math.floor(date.getTime()/ms)*ms);} 
function addMinutes(date,n){return new Date(date.getTime()+n*60000);} 
function formatDate(iso){return new Date(iso).toLocaleDateString('fr-FR');}
function formatTime(iso){return new Date(iso).toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'});} 
function dynamicPadelPrice(startISO,minutes){const start=new Date(startISO);const end=addMinutes(start,minutes);const split=new Date(start);split.setHours(17,0,0,0);const rate1=5,rate2=6;let price=0;if(end<=split){price=rate1*(minutes/60);}else if(start>=split){price=rate2*(minutes/60);}else{const before=(split-start)/60000;const after=minutes-before;price=rate1*(before/60)+rate2*(after/60);}return Math.round(price*100)/100;}
function priceFor(sport,startISO,minutes,players){if(sport==='Padel')return dynamicPadelPrice(startISO,minutes);if(sport==='Tennis')return 8*(minutes/60)*(players||2);if(sport==='Football')return 50*(minutes/60);return 0;}
/* ==== Validations ==== */
function isOverlapping(a,b){return Math.max(a.start,b.start)<Math.min(a.end,b.end);} 
function createsOneHourGap(candidate,existing,opening){const list=existing.slice();list.push(candidate);list.sort((x,y)=>x.start-y.start);let prev=toMinutes(opening.start);for(const item of list){if(item.start-prev===60)return true;prev=item.end;}return (toMinutes(opening.end)-prev===60);} 
function withinOpening(cand,opening){return cand.start>=toMinutes(opening.start)&&cand.end<=toMinutes(opening.end);} 
function notInPast(startISO){return new Date(startISO)>new Date();}
function userQuotaOK(email){const now=new Date();return loadBookings().filter(b=>b.customer.email===email && new Date(b.startISO)>now && b.status!=='annulée').length < LIMITS.maxActiveBookingsPerUser;}
/* ==== UI helpers ==== */
function toast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000);} 
function showView(id){document.querySelectorAll('.view').forEach(v=>v.classList.add('hidden'));document.getElementById(id).classList.remove('hidden');}
/* ==== Client Réservation ==== */
let currentSport=null;document.getElementById('toReserve').onclick=()=>sportDialog.showModal();
Array.from(document.getElementsByClassName('sportSelect')).forEach(btn=>btn.onclick=e=>{currentSport=e.target.dataset.sport;document.getElementById('breadcrumbSport').textContent=currentSport;document.getElementById('dateInput').value=new Date().toISOString().slice(0,10);renderClientDay();sportDialog.close();showView('booking');});
function renderClientDay(){const date=document.getElementById('dateInput').value;const courts=SPORTS[currentSport].courts;const container=document.getElementById('courtsContainer');container.innerHTML='';courts.forEach(c=>{const div=document.createElement('div');div.className='court';div.innerHTML=`<h3>${c.id}</h3>`;const slots=document.createElement('div');slots.className='slots';const bookings=loadBookings().filter(b=>b.date===date && b.courtId===c.id);const times=generateTimeScale(OPENING);SPORTS[currentSport].durations.forEach(dur=>{times.forEach(time=>{const start=toMinutes(time);const candidate={start,end:start+dur};if(candidate.end>toMinutes(OPENING.end))return;const overlap=bookings.some(b=>isOverlapping(candidate,{start:toMinutes(b.startISO.slice(11,16)),end:toMinutes(b.endISO.slice(11,16))}));if(overlap) return; if(createsOneHourGap(candidate,bookings.map(b=>({start:toMinutes(b.startISO.slice(11,16)),end:toMinutes(b.endISO.slice(11,16))})),OPENING)) return; const btn=document.createElement('button');btn.className='slot';const startISO=`${date}T${time}`;const price=priceFor(currentSport,startISO,dur, currentSport==='Tennis'?2:undefined);btn.innerHTML=`${time}<div class="badges"><span class="badge duration">${dur===90?'1h30':'2h'}</span><span class="badge price">${price.toFixed(2)} €</span></div>`;btn.onclick=()=>{confirmDialog.dataset.sport=currentSport;confirmDialog.dataset.court=c.id;confirmDialog.dataset.startISO=startISO;confirmDialog.dataset.minutes=dur;confirmDialog.dataset.price=price;document.getElementById('confirmText').textContent=`${c.id} - ${time} (${dur===90?'1h30':'2h'})`;document.getElementById('playerField').classList.toggle('hidden',currentSport!=='Tennis');confirmDialog.showModal();};slots.appendChild(btn);});});div.appendChild(slots);container.appendChild(div);});}

document.getElementById('dateInput').onchange=renderClientDay;document.getElementById('prevDay').onclick=()=>{const d=new Date(dateInput.value);d.setDate(d.getDate()-1);dateInput.value=d.toISOString().slice(0,10);renderClientDay();};document.getElementById('nextDay').onclick=()=>{const d=new Date(dateInput.value);d.setDate(d.getDate()+1);dateInput.value=d.toISOString().slice(0,10);renderClientDay();};document.getElementById('todayBtn').onclick=()=>{dateInput.value=new Date().toISOString().slice(0,10);renderClientDay();};

document.getElementById('confirmForm').onsubmit=e=>{e.preventDefault();const sport=confirmDialog.dataset.sport;const courtId=confirmDialog.dataset.court;const startISO=confirmDialog.dataset.startISO;const minutes=parseInt(confirmDialog.dataset.minutes);const price=parseFloat(confirmDialog.dataset.price);const players=currentSport==='Tennis'?parseInt(document.getElementById('playerCount').value)||2:null;const profile=loadProfile();const customer={name:profile.name||'Anonyme',phone:profile.phone,email:profile.email};if(!notInPast(startISO)){toast('Créneau dans le passé');return;}if(customer.email && !userQuotaOK(customer.email)){toast('Limite de réservations atteinte');return;}const candidate={start:toMinutes(startISO.slice(11,16)),end:toMinutes(startISO.slice(11,16))+minutes};const courtBookings=loadBookings().filter(b=>b.date===startISO.slice(0,10)&&b.courtId===courtId);if(courtBookings.some(b=>isOverlapping(candidate,{start:toMinutes(b.startISO.slice(11,16)),end:toMinutes(b.endISO.slice(11,16))}))){toast('Chevauchement sur '+courtId);return;}if(createsOneHourGap(candidate,courtBookings.map(b=>({start:toMinutes(b.startISO.slice(11,16)),end:toMinutes(b.endISO.slice(11,16))})),OPENING)){toast('La modification crée un trou d\'1h');return;}const id='b'+Date.now();const endISO=addMinutes(new Date(startISO),minutes).toISOString().slice(0,16);saveBooking({id,sport,courtId,date:startISO.slice(0,10),startISO,endISO,minutes,players,price,createdBy:'client',customer,status:'confirmée'});confirmDialog.close();toast('Réservation confirmée');renderClientDay();renderBookings();renderAdminGrid();};
/* ==== Mes réservations ==== */
function renderBookings(){const list=document.getElementById('bookingList');list.innerHTML='';const now=new Date();loadBookings().sort((a,b)=>new Date(a.startISO)-new Date(b.startISO)).forEach(b=>{const li=document.createElement('li');li.textContent=`${b.sport} ${b.courtId} ${formatDate(b.startISO)} ${formatTime(b.startISO)} (${b.minutes===90?'1h30':'2h'}) - ${b.price.toFixed(2)} €`;const btn=document.createElement('button');btn.textContent='Annuler';const diff=(new Date(b.startISO)-now)/3600000;if(diff>LIMITS.cancelCutoffHours){btn.onclick=()=>{deleteBooking(b.id);renderBookings();renderClientDay();renderAdminGrid();};}else{btn.disabled=true;btn.title='Annulation impossible à moins de 24h';}li.appendChild(document.createElement('br'));li.appendChild(btn);list.appendChild(li);});}
/* ==== Événements ==== */
function renderEvents(){const events=storageGet('events',[]);document.getElementById('eventCount').textContent=events.length;const tbody=document.querySelector('#eventsTable tbody');tbody.innerHTML='';events.forEach(ev=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${formatDate(ev.date)}</td><td>${ev.title}</td><td>${ev.type}</td><td>${ev.fee} €</td><td><button class="small-btn" disabled>Inscription</button></td>`;tbody.appendChild(tr);});}
/* ==== Profil ==== */
function initProfile(){const p=loadProfile();profileName.value=p.name||'';profileEmail.value=p.email||'';profilePhone.value=p.phone||'';const prefs=loadPrefs();document.body.classList.toggle('dark',prefs.theme==='dark');darkToggle.checked=prefs.theme==='dark';}
profileForm.onsubmit=e=>{e.preventDefault();saveProfile({name:profileName.value,email:profileEmail.value,phone:profilePhone.value});const prefs=loadPrefs();prefs.theme=darkToggle.checked?'dark':'light';savePrefs(prefs);document.body.classList.toggle('dark',prefs.theme==='dark');toast('Profil sauvegardé');};
/* ==== Admin ==== */
function renderAdminGrid(){const date=document.getElementById('adminDate').value;const sportFilter=document.getElementById('adminSportFilter').value;const search=document.getElementById('adminSearch').value.toLowerCase();const container=document.getElementById('adminGrid');container.innerHTML='';const allCourts=[...SPORTS.Padel.courts,...SPORTS.Tennis.courts,...SPORTS.Football.courts];const times=generateTimeScale(OPENING);const grid=document.createElement('div');grid.className='grid';grid.style.gridTemplateColumns=`60px repeat(${allCourts.length},1fr)`;grid.style.height=`${times.length*parseInt(getComputedStyle(document.documentElement).getPropertyValue('--cell'))}px`;container.appendChild(grid);
// time column
const timeCol=document.createElement('div');timeCol.className='time-col';times.forEach(t=>{const div=document.createElement('div');div.className='time-slot';div.textContent=t;timeCol.appendChild(div);});grid.appendChild(timeCol);
let revenue=0,count=0;allCourts.forEach(c=>{const col=document.createElement('div');col.className='court-col';col.dataset.court=c.id;col.dataset.sport=c.id.startsWith('Padel')?'Padel':c.id.startsWith('Tennis')?'Tennis':'Football';col.style.height=timeCol.style.height;col.onclick=e=>{if(e.target!==col)return;const y=e.offsetY;const step=parseInt(getComputedStyle(document.documentElement).getPropertyValue('--cell'));const minutes=toMinutes(OPENING.start)+Math.floor(y/step)*OPENING.stepMinutes;openAdminForm({mode:'create',court:c.id,sport:col.dataset.sport,start:fromMinutes(minutes),date});};grid.appendChild(col);const bookings=loadBookings().filter(b=>b.courtId===c.id && b.date===date);bookings.forEach(b=>{if(sportFilter!=='all' && b.sport!==sportFilter)return;const searchText=`${b.customer.name||''} ${b.customer.email||''} ${b.customer.phone||''}`.toLowerCase();if(search && !searchText.includes(search)) return;const div=document.createElement('div');div.className=`booking ${b.sport.toLowerCase()}`;div.style.top=`${(toMinutes(b.startISO.slice(11,16))-toMinutes(OPENING.start))/OPENING.stepMinutes*parseInt(getComputedStyle(document.documentElement).getPropertyValue('--cell'))}px`;div.style.height=`${b.minutes/OPENING.stepMinutes*parseInt(getComputedStyle(document.documentElement).getPropertyValue('--cell'))}px`;div.textContent=`${formatTime(b.startISO)}-${formatTime(b.endISO)} ${b.customer.name||''}`;div.onclick=e=>{e.stopPropagation();openAdminForm({mode:'edit',booking:b});};col.appendChild(div);if(b.status!=='annulée'){revenue+=b.price;count++;}});});document.getElementById('adminStats').textContent=`${count} créneaux, ${revenue.toFixed(2)} €`;
}
function openAdminForm(opts){adminForm.reset();if(opts.mode==='create'){adminFormTitle.textContent='Nouvelle réservation';adminDelete.style.display='none';adminForm.dataset.mode='create';adminForm.dataset.court=opts.court;adminForm.dataset.sport=opts.sport;adminForm.dataset.id='';adminPlayersLabel.classList.toggle('hidden',opts.sport!=='Tennis');fillStartSelect(opts.start);document.getElementById('adminDate').value=opts.date;}else{adminFormTitle.textContent='Modifier';adminDelete.style.display='inline-block';const b=opts.booking;adminForm.dataset.mode='edit';adminForm.dataset.id=b.id;adminForm.dataset.court=b.courtId;adminForm.dataset.sport=b.sport;fillStartSelect(b.startISO.slice(11,16));adminDuration.value=b.minutes;adminName.value=b.customer.name||'';adminPhone.value=b.customer.phone||'';adminEmail.value=b.customer.email||'';adminPlayersLabel.classList.toggle('hidden',b.sport!=='Tennis');adminPlayers.value=b.players||2;adminStatus.value=b.status;adminScore.value=b.score||'';}
adminDialog.showModal();}
function fillStartSelect(selected){const date=document.getElementById('adminDate').value;adminStart.innerHTML='';generateTimeScale(OPENING).forEach(t=>{const opt=document.createElement('option');opt.value=t;opt.textContent=t;opt.selected=(t===selected);adminStart.appendChild(opt);});}
adminForm.onsubmit=e=>{e.preventDefault();const mode=adminForm.dataset.mode;const sport=adminForm.dataset.sport;const court=adminForm.dataset.court;const start=adminStart.value;const minutes=parseInt(adminDuration.value);const date=document.getElementById('adminDate').value;const startISO=`${date}T${start}`;const endISO=addMinutes(new Date(startISO),minutes).toISOString().slice(0,16);const price=priceFor(sport,startISO,minutes, sport==='Tennis'?parseInt(adminPlayers.value):undefined);const customer={name:adminName.value,phone:adminPhone.value,email:adminEmail.value};const candidate={start:toMinutes(start),end:toMinutes(start)+minutes};const existing=loadBookings().filter(b=>b.date===date && b.courtId===court && (mode==='create' || b.id!==adminForm.dataset.id));if(!withinOpening(candidate,OPENING)){toast('Hors ouverture');return;}if(existing.some(b=>isOverlapping(candidate,{start:toMinutes(b.startISO.slice(11,16)),end:toMinutes(b.endISO.slice(11,16))}))){toast('Chevauchement sur '+court);return;}if(createsOneHourGap(candidate,existing.map(b=>({start:toMinutes(b.startISO.slice(11,16)),end:toMinutes(b.endISO.slice(11,16))})),OPENING)){toast('La modification crée un trou d\'1h');return;}if(customer.email && !userQuotaOK(customer.email)){toast('Limite de résas pour cet utilisateur');return;}const booking={id:mode==='edit'?adminForm.dataset.id:'b'+Date.now(),sport,courtId:court,date,startISO,endISO,minutes,players:sport==='Tennis'?parseInt(adminPlayers.value):null,price,createdBy:'admin',customer,status:adminStatus.value,score:adminScore.value};if(mode==='edit'){updateBooking(booking);}else{saveBooking(booking);}adminDialog.close();renderAdminGrid();renderClientDay();renderBookings();};adminDelete.onclick=()=>{if(adminForm.dataset.id){deleteBooking(adminForm.dataset.id);adminDialog.close();renderAdminGrid();renderClientDay();renderBookings();}}
/* ==== export CSV ==== */
document.getElementById('exportCsv').onclick=()=>{const date=document.getElementById('adminDate').value;const rows=['id,sport,court,date,start,end,minutes,client,price,status,score'];loadBookingsByDate(date).forEach(b=>{rows.push([b.id,b.sport,b.courtId,b.date,b.startISO,b.endISO,b.minutes,b.customer.name||'',b.price,b.status,b.score||''].map(x=>`"${x}"`).join(','));});const blob=new Blob([rows.join('\n')],{type:'text/csv'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`bookings-${date}.csv`;a.click();};
/* ==== Navigation ==== */
document.querySelectorAll('.backHome').forEach(b=>b.onclick=()=>showView('home'));
['toEvents','toMy','toAccount','toAdmin'].forEach(id=>document.getElementById(id).onclick=()=>{if(id==='toEvents'){renderEvents();showView('events');}if(id==='toMy'){renderBookings();showView('myBookings');}if(id==='toAccount'){initProfile();showView('account');}if(id==='toAdmin'){adminDate.value=new Date().toISOString().slice(0,10);renderAdminGrid();showView('admin');}});
document.getElementById('adminPrev').onclick=()=>{const d=new Date(adminDate.value);d.setDate(d.getDate()-1);adminDate.value=d.toISOString().slice(0,10);renderAdminGrid();};document.getElementById('adminNext').onclick=()=>{const d=new Date(adminDate.value);d.setDate(d.getDate()+1);adminDate.value=d.toISOString().slice(0,10);renderAdminGrid();};document.getElementById('adminDate').onchange=renderAdminGrid;document.getElementById('adminSportFilter').onchange=renderAdminGrid;document.getElementById('adminSearch').oninput=renderAdminGrid;
/* init */
renderEvents();initProfile();
</script>
</body>
</html>
