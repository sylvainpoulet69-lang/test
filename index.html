<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>RÃ©servations Padel/Tennis</title>
<style>
body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#f5f5f5;color:#222;}
.hidden{display:none;}
#toolbar{padding:.5rem;background:#fff;box-shadow:0 2px 4px rgba(0,0,0,.1);position:sticky;top:0;z-index:10;display:flex;gap:.5rem;align-items:center;}
#clientView .court{margin:1rem;}
.slot-card{display:flex;align-items:center;justify-content:space-between;background:#fff;padding:.5rem;border-radius:6px;box-shadow:0 2px 4px rgba(0,0,0,.1);margin:.25rem 0;}
.slot-card .icon{margin-right:.5rem;}
.slot-card .badge{background:#1976d2;color:#fff;padding:.25rem .5rem;border-radius:4px;margin:0 .5rem;}
#adminView{position:relative;height:600px;overflow:auto;background:#fff;margin:1rem;border:1px solid #ccc;}
#timeline{position:relative;display:flex;}
.time-column{width:60px;flex-shrink:0;background:#fafafa;border-right:1px solid #ddd;}
.time-label{height:40px;line-height:40px;font-size:12px;border-bottom:1px solid #eee;padding-left:4px;}
.court-column{position:relative;flex:1;border-right:1px solid #ddd;}
.court-header{position:sticky;top:0;background:#fff;border-bottom:1px solid #ddd;text-align:center;font-weight:bold;}
.hour-line{position:absolute;left:0;right:0;height:1px;background:#ccc;}
.booking{position:absolute;background:#1976d2;color:#fff;border-radius:4px;padding:2px 4px;font-size:12px;cursor:grab;user-select:none;}
.booking.dragging{opacity:.7;}
.booking.invalid{background:#b71c1c;}
.popover{position:absolute;background:#fff;border:1px solid #ccc;border-radius:4px;padding:.5rem;font-size:12px;box-shadow:0 2px 6px rgba(0,0,0,.2);}
#toast{position:fixed;bottom:1rem;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:.5rem 1rem;border-radius:4px;opacity:0;transition:opacity .3s;}
#toast.show{opacity:1;}
</style>
</head>
<body>
<div id="toolbar">
<button id="showClient">Client</button>
<button id="showAdmin">Admin</button>
<input type="date" id="datePicker">
<input type="text" id="search" placeholder="Recherche nom">
<button id="exportCsv">Export CSV</button>
</div>
<div id="clientView"></div>
<div id="adminView" class="hidden"><div id="timeline"></div></div>
<div id="popover" class="popover hidden"></div>
<div id="toast"></div>
<script>
(function(){
const dayStart=timeToMinutes("08:00");
const dayEnd=timeToMinutes("22:30");
const step=30; // minutes
const cellH=40; // px per 30min
const durations=[60,90,120];
const courts=Array.from({length:4},(_,i)=>({id:`Padel ${i+1}`}));
let state=loadState();
let currentDate=new Date().toISOString().slice(0,10);
const timeline=document.getElementById('timeline');
const clientView=document.getElementById('clientView');
const adminView=document.getElementById('adminView');
const popover=document.getElementById('popover');
const toastBox=document.getElementById('toast');

document.getElementById('datePicker').value=currentDate;

document.getElementById('showClient').onclick=()=>{clientView.classList.remove('hidden');adminView.classList.add('hidden');renderClient();};
document.getElementById('showAdmin').onclick=()=>{adminView.classList.remove('hidden');clientView.classList.add('hidden');renderAdmin();};
document.getElementById('datePicker').onchange=e=>{currentDate=e.target.value;render();};
document.getElementById('search').oninput=renderAdmin;
document.getElementById('exportCsv').onclick=exportCsv;

document.addEventListener('click',e=>{if(!popover.contains(e.target))popover.classList.add('hidden');});

render();

function render(){renderClient();renderAdmin();}

function timeToMinutes(t){const [h,m]=t.split(':').map(Number);return h*60+m;}
function minutesToTime(m){const h=String(Math.floor(m/60)).padStart(2,'0');const min=String(m%60).padStart(2,'0');return `${h}:${min}`;}
function getPrice(start,dur){let rate=4;if(start<17*60)rate=5;else if(start<20*60)rate=6;return Math.round(rate*dur/60);}
function detectCollision(list,c){return list.some(r=>c.start<r.end && c.end>r.start);}
function violatesOneHourGapRule(list,c){const arr=[...list,c].sort((a,b)=>a.start-b.start);for(let i=0;i<arr.length-1;i++){if(arr[i+1].start-arr[i].end===60)return true;}return false;}
function generateAvailability(reservations,courts){const avail={};courts.forEach(ct=>{const res=reservations.filter(r=>r.court===ct.id).map(r=>({start:r.start,end:r.end}));const slots=[];for(let start=dayStart;start<=dayEnd-durations[0];start+=step){durations.forEach(dur=>{const cand={start,end:start+dur};if(cand.end>dayEnd)return;if(detectCollision(res,cand))return;if(violatesOneHourGapRule(res,cand))return;slots.push({start:cand.start,duration:dur,price:getPrice(cand.start,dur)});});}avail[ct.id]=slots;});return avail;}
function saveState(){localStorage.setItem('reservations',JSON.stringify(state));}
function loadState(){return JSON.parse(localStorage.getItem('reservations')||'{}');}
function renderClient(){clientView.innerHTML='';const reservations=state[currentDate]||[];const avail=generateAvailability(reservations,courts);courts.forEach(c=>{const div=document.createElement('div');div.className='court';const h=document.createElement('h3');h.textContent=c.id;div.appendChild(h);avail[c.id].forEach(slot=>{const card=document.createElement('div');card.className='slot-card';const left=document.createElement('span');left.className='icon';left.textContent='ðŸ•’ '+minutesToTime(slot.start);const badge=document.createElement('span');badge.className='badge';badge.textContent=(slot.duration===60?'1h':slot.duration===90?'1h30':'2h');const price=document.createElement('span');price.textContent=`${slot.price} â‚¬`;const btn=document.createElement('button');btn.textContent='RÃ©server';btn.onclick=()=>{const res={id:'r'+Date.now(),name:'aaa',court:c.id,start:slot.start,end:slot.start+slot.duration};if(!state[currentDate])state[currentDate]=[];state[currentDate].push(res);saveState();render();};card.append(left,badge,price,btn);div.appendChild(card);});clientView.appendChild(div);});}
function renderAdmin(){timeline.innerHTML='';const reservations=(state[currentDate]||[]).slice();const query=document.getElementById('search').value.toLowerCase();const timeCol=document.createElement('div');timeCol.className='time-column';for(let t=dayStart;t<dayEnd;t+=step){const lab=document.createElement('div');lab.className='time-label';lab.textContent=t%60===0?minutesToTime(t):'';timeCol.appendChild(lab);}timeline.appendChild(timeCol);courts.forEach(ct=>{const col=document.createElement('div');col.className='court-column';col.dataset.court=ct.id;const header=document.createElement('div');header.className='court-header';header.textContent=ct.id;col.appendChild(header);for(let t=dayStart;t<dayEnd;t+=60){const line=document.createElement('div');line.className='hour-line';line.style.top=((t-dayStart)/step*cellH)+'px';col.appendChild(line);}const res=reservations.filter(r=>r.court===ct.id);res.forEach(r=>{if(query && !r.name.toLowerCase().includes(query))return;const div=document.createElement('div');div.className='booking';div.tabIndex=0;div.textContent=`${minutesToTime(r.start)}-${minutesToTime(r.end)} ${r.name}`;div.style.top=((r.start-dayStart)/step*cellH)+'px';div.style.height=((r.end-r.start)/step*cellH)+'px';enableDrag(div,r);div.addEventListener('click',e=>openPopover(e,r));col.appendChild(div);});timeline.appendChild(col);});}
function enableDrag(el,res){let startX,startY,startCourtIdx,courtWidth,origStart,raf=null,dx=0,dy=0;const columns=Array.from(timeline.querySelectorAll('.court-column'));el.addEventListener('pointerdown',e=>{e.preventDefault();el.setPointerCapture(e.pointerId);startX=e.clientX;startY=e.clientY;origStart=res.start;startCourtIdx=columns.indexOf(el.parentElement);courtWidth=el.parentElement.offsetWidth;el.classList.add('dragging');el.addEventListener('pointermove',move);el.addEventListener('pointerup',up);});function move(e){dx=e.clientX-startX;dy=e.clientY-startY;if(!raf)raf=requestAnimationFrame(apply);}function apply(){raf=null;const minutes=Math.round(dy/cellH)*step;const courtShift=Math.round(dx/courtWidth);const newStart=origStart+minutes;const newCourtIdx=Math.max(0,Math.min(courts.length-1,startCourtIdx+courtShift));const candidate={start:newStart,end:newStart+(res.end-res.start)};const list=(state[currentDate]||[]).filter(r=>r.id!==res.id && r.court===courts[newCourtIdx].id).map(r=>({start:r.start,end:r.end}));let invalid=false;if(newStart<dayStart || candidate.end>dayEnd)invalid=true;else if(detectCollision(list,candidate))invalid=true;else if(violatesOneHourGapRule(list,candidate))invalid=true;el.style.transform=`translate(${courtShift*courtWidth}px,${minutes/step*cellH}px)`;el.classList.toggle('invalid',invalid);el.dataset.newStart=newStart;el.dataset.newCourtIdx=newCourtIdx;}function up(e){el.releasePointerCapture(e.pointerId);el.classList.remove('dragging');const invalid=el.classList.contains('invalid');el.classList.remove('invalid');el.style.transform='';el.removeEventListener('pointermove',move);el.removeEventListener('pointerup',up);if(invalid){renderAdmin();return;}const minutes=parseInt(el.dataset.newStart);const newCourtIdx=parseInt(el.dataset.newCourtIdx);res.start=minutes;res.end=minutes+(res.end-res.start);res.court=courts[newCourtIdx].id;saveState();render();toast(`RÃ©servation dÃ©placÃ©e: ${res.court} â€¢ ${minutesToTime(res.start)}â€“${minutesToTime(res.end)}`);}el.addEventListener('keydown',e=>{if(e.key==='ArrowUp'){moveBy(-step);}if(e.key==='ArrowDown'){moveBy(step);}if(e.key==='ArrowLeft'){changeCourt(-1);}if(e.key==='ArrowRight'){changeCourt(1);}});function moveBy(delta){const candidate={start:res.start+delta,end:res.end+delta};const list=(state[currentDate]||[]).filter(r=>r.id!==res.id && r.court===res.court).map(r=>({start:r.start,end:r.end}));if(candidate.start<dayStart||candidate.end>dayEnd) return;if(detectCollision(list,candidate)) return;if(violatesOneHourGapRule(list,candidate)) return;res.start+=delta;res.end+=delta;saveState();render();}
function changeCourt(dir){const idx=courts.findIndex(c=>c.id===res.court)+dir;if(idx<0||idx>=courts.length)return;const list=(state[currentDate]||[]).filter(r=>r.id!==res.id && r.court===courts[idx].id).map(r=>({start:r.start,end:r.end}));const candidate={start:res.start,end:res.end};if(detectCollision(list,candidate))return;if(violatesOneHourGapRule(list,candidate))return;res.court=courts[idx].id;saveState();render();}}
function openPopover(e,res){popover.innerHTML=`<div>${res.court} ${minutesToTime(res.start)}-${minutesToTime(res.end)}<br>${res.name}</div><div><button data-dur="60">1h</button><button data-dur="90">1h30</button><button data-dur="120">2h</button></div><button id="del">Supprimer</button>`;popover.style.left=e.pageX+'px';popover.style.top=e.pageY+'px';popover.classList.remove('hidden');popover.querySelectorAll('button[data-dur]').forEach(b=>{b.onclick=()=>{const newDur=parseInt(b.dataset.dur);const cand={start:res.start,end:res.start+newDur};const list=(state[currentDate]||[]).filter(r=>r.id!==res.id && r.court===res.court).map(r=>({start:r.start,end:r.end}));if(cand.end>dayEnd||detectCollision(list,cand)||violatesOneHourGapRule(list,cand))return;res.end=res.start+newDur;saveState();render();popover.classList.add('hidden');};});popover.querySelector('#del').onclick=()=>{state[currentDate]=state[currentDate].filter(r=>r.id!==res.id);saveState();render();popover.classList.add('hidden');};}
function exportCsv(){const rows=['date,court,start,end,durationMin,price,name'];(state[currentDate]||[]).forEach(r=>{rows.push([currentDate,r.court,minutesToTime(r.start),minutesToTime(r.end),r.end-r.start,getPrice(r.start,r.end-r.start),r.name].join(','));});const blob=new Blob([rows.join('\n')],{type:'text/csv'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`reservations-${currentDate}.csv`;a.click();}
function toast(msg){toastBox.textContent=msg;toastBox.classList.add('show');setTimeout(()=>toastBox.classList.remove('show'),2000);}
if(!state[currentDate]){state[currentDate]=[];seed();saveState();}
function seed(){function add(court,start,end){state[currentDate].push({id:'s'+Math.random(),name:'aaa',court,start:timeToMinutes(start),end:timeToMinutes(end)});}add('Padel 1','10:00','11:00');add('Padel 1','12:00','13:00');add('Padel 1','14:00','16:00');add('Padel 3','09:00','10:30');add('Padel 4','17:00','18:30');}
})();
</script>
</body>
</html>
